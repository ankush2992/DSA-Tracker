{% extends 'base.html' %}
{% block content %}
<div class="row g-4 align-items-stretch">
  <div class="col-xl-4">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <h5 class="mb-1">Add Problem</h5>
        <p class="text-muted small mb-3">Capture a new challenge and keep your practice list up to date.</p>
        <form method="post" action="{{ url_for('problems_new') }}">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Title</label>
              <input class="form-control" name="title" placeholder="Problem title" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Topic</label>
              <select class="form-select" name="topic_id">
                <option value="">-- Topic --</option>
                {% for t in topics %}<option value="{{ t.id }}">{{ t.name }}</option>{% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Difficulty</label>
              <select class="form-select" name="difficulty">
                <option value="">-- Difficulty --</option>
                <option value="Easy">Easy</option>
                <option value="Medium">Medium</option>
                <option value="Hard">Hard</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Source</label>
              <select class="form-select" name="source">
                <option value="LeetCode">LeetCode</option>
                <option value="Geeks for Geeks">Geeks for Geeks</option>
                <option value="NeetCode">NeetCode</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Link</label>
              <input class="form-control" name="link" placeholder="https://">
            </div>
            <div class="col-12">
              <label class="form-label">Tags</label>
              <input class="form-control" name="tags" placeholder="Arrays, Two Pointers">
            </div>
            <div class="col-md-6">
              <label class="form-label">Logged Date</label>
              <div class="input-group">
                <input type="date" class="form-control" name="first_logged_date" id="add-problem-date" value="{{ today.isoformat() }}">
                <button type="button" class="btn btn-outline-secondary" id="add-problem-date-today">Today</button>
              </div>
            </div>
            <div class="col-md-6">
              <label class="form-label">Time Spent (minutes)</label>
              <div class="input-group">
                <input type="number" class="form-control" name="first_logged_minutes" id="add-problem-minutes" min="0" step="5" placeholder="e.g. 25">
                <button type="button" class="btn btn-outline-secondary" id="add-problem-minutes-fill">Set</button>
              </div>
            </div>
            <div class="col-12">
              <label class="form-label">Notes</label>
              <textarea class="form-control" rows="3" name="notes" placeholder="Key ideas, blockers, follow-up tasks"></textarea>
            </div>
            <div class="col-12 d-grid">
              <button class="btn btn-gradient btn-lg">Add Problem</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
  <div class="col-xl-8">
    <div class="card h-100 shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h5 class="mb-1">Progress Snapshot</h5>
            <p class="text-muted small mb-0">Track how many problems you’ve logged and what needs a revisit.</p>
          </div>
          <a class="btn btn-sm btn-gradient" href="{{ url_for('reviews_board') }}">Open Review Board</a>
        </div>
        <div class="row row-cols-1 row-cols-md-3 g-3">
          <div class="col">
            <div class="border border-dashed rounded-3 p-3 h-100">
              <span class="text-muted small text-uppercase d-block">Total Problems</span>
              <h3 class="mb-0">{{ totals.total }}</h3>
            </div>
          </div>
          <div class="col">
            <div class="border border-dashed rounded-3 p-3 h-100">
              <span class="text-muted small text-uppercase d-block">Marked to Revisit</span>
              <h3 class="mb-0 text-accent">{{ totals.needs_review }}</h3>
            </div>
          </div>
          <div class="col">
            <div class="border border-dashed rounded-3 p-3 h-100">
              <span class="text-muted small text-uppercase d-block">Solved this week</span>
              <h3 class="mb-0">{{ totals.recent_solves }}</h3>
            </div>
          </div>
        </div>
        <div class="mt-4">
          <h6 class="text-muted text-uppercase small mb-2">Needs attention</h6>
          {% if review_queue_preview %}
            <ul class="list-unstyled mb-0">
              {% for item in review_queue_preview %}
              <li class="d-flex align-items-center justify-content-between border-bottom py-2">
                <div>
                  <span class="fw-semibold">{{ item.title }}</span>
                  <div class="small text-muted">
                    Priority: {{ item.review_priority }}{% if item.next_review_date %} · Next session: {{ item.next_review_date.strftime('%d %b %Y') }}{% endif %}
                  </div>
                </div>
                <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('reviews_board', problem_id=item.id) }}">Review</a>
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="text-muted small mb-0">Nothing in the review queue. Great job!</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card mt-4 shadow-sm">
  <div class="card-body">
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-3">
      <h5 class="mb-2 mb-lg-0">Problem Library</h5>
      <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('reviews_board') }}">See detailed history</a>
    </div>
    {% if grouped_topics %}
      {% for group in grouped_topics %}
      <div class="mb-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">{{ group.title }}</h6>
          <span class="badge badge-pill bg-secondary-subtle text-secondary">{{ group.count }}</span>
        </div>
        <div class="table-responsive">
          <table class="table table-striped align-middle table-hover">
            <thead class="table-light">
              <tr>
                <th>Title</th>
                <th>Diff</th>
                <th>Last Solve</th>
                <th>Review</th>
                <th class="text-end">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for p in group.problems %}
                {% set summary = resolve_summary.get(p.id, {}) %}
                {% set last_date = summary.get('last_date') %}
                <tr>
                  <td class="fw-semibold">
                    {% if p.link %}<a href="{{ p.link }}" target="_blank">{{ p.title }}</a>{% else %}{{ p.title }}{% endif %}
                    {% if p.tags %}
                      <div class="small text-muted">{{ p.tags }}</div>
                    {% endif %}
                  </td>
                  <td>{{ p.difficulty or '--' }}</td>
                  <td>
                    {% if last_date %}
                      <div>{{ last_date.strftime('%d %b %Y') }}</div>
                      {% if summary.get('last_minutes') %}
                      <div class="small text-muted">{{ summary.get('last_minutes') }} min · {{ summary.get('last_outcome') or 'Logged' }}</div>
                      {% endif %}
                    {% else %}
                      <span class="text-muted">Not logged yet</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if p.needs_review %}
                      <span class="badge badge-pill bg-danger-subtle text-danger mb-1">Needs review</span>
                      <div class="small text-muted">Priority: {{ p.review_priority }}</div>
                      {% if p.next_review_date %}
                      <div class="small text-muted">Next: {{ p.next_review_date.strftime('%d %b %Y') }}</div>
                      {% endif %}
                    {% else %}
                      <span class="badge badge-pill bg-success-subtle text-success">On track</span>
                    {% endif %}
                  </td>
                  <td class="text-end">
                    <div class="d-flex flex-column flex-lg-row gap-2 justify-content-end">
                      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('problems_edit', pid=p.id) }}">Edit</a>
                      <form method="post" action="{{ url_for('problems_review', pid=p.id) }}">
                        <input type="hidden" name="redirect" value="{{ url_for('problems_list') }}">
                        <input type="hidden" name="review_state" value="{{ 'off' if p.needs_review else 'on' }}">
                        <button class="btn btn-sm btn-outline-secondary" type="submit">
                          {% if p.needs_review %}Clear mark{% else %}Mark revisit{% endif %}
                        </button>
                      </form>
                      <a class="btn btn-sm btn-gradient" href="{{ url_for('reviews_board', problem_id=p.id) }}">Review</a>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <p class="text-muted mb-0">No problems logged yet. Start by adding your first challenge!</p>
    {% endif %}
  </div>
</div>
{% endblock %}
